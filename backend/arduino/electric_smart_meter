#include "EmonLib.h" // Include the EmonLib library

EnergyMonitor emon1; // Create an instance of EmonLib

#define VOLTAGE_SENSOR_PIN 35  // ZMPT101B connected to GPIO 35
#define CURRENT_SENSOR_PIN 34  // SCT-013 connected to GPIO 34
#define VCAL 94.5              // Voltage calibration factor for 230V system
#define CCAL 0.52              // Current calibration factor

void setup() {
    Serial.begin(115200);
    analogReadResolution(12);

    // Configure EmonLib for voltage and current measurement
    emon1.voltage(VOLTAGE_SENSOR_PIN, VCAL, 1.7); // (Pin, Calibration factor, Phase shift)
    emon1.current(CURRENT_SENSOR_PIN, CCAL);      // (Pin, Calibration factor)
}
float energyConsumed = 0.0;  // kWh storage

void loop() {
    emon1.calcVI(20, 2000);

    float measuredVoltage = emon1.Vrms;
    float measuredCurrent = emon1.Irms;

    float apparentPower = measuredVoltage * measuredCurrent;
    float realPower = emon1.realPower;
    float pf = (apparentPower > 0) ? (realPower / apparentPower) : 0;

    // Calculate energy consumption
    float timeInterval = 1.0 / 3600.0; // Convert 1 second to hours
    energyConsumed += (realPower * timeInterval); // kWh

    Serial.print("Measured Voltage: ");
    Serial.print(measuredVoltage, 2);
    Serial.print(" V\t");

    Serial.print("Measured Current: ");
    Serial.print(measuredCurrent, 4);
    Serial.print(" A\t");

    Serial.print("Real Power: ");
    Serial.print(realPower, 2);
    Serial.print(" W\t");

    Serial.print("Power Factor: ");
    Serial.print(pf, 2);
    Serial.print("\t");

    Serial.print("Energy Consumed: ");
    Serial.print(energyConsumed, 4);
    Serial.println(" kWh");

    delay(1000);
}
